<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
      
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: 'EANI2G9IBU',
      apiKey: 'a8cc8f9e5688c20770172ad27daeead0',
      indexName: 'blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"请输入搜索内容","hits_empty":"没有发现和 ${query} 有关的内容","hits_stats":"在 ${time} ms 内发现 ${hits} "}
    }
  };
</script>


  




  <meta name="description" content="原文 为何废弃 Thread.stop因为它本质上是不安全的。stop线程将导致释放其持有的全部monitor（ThreadDeath异常在栈中传播时，monitor被解锁），若在当前线程中，这些monitor保护的对象处于不一致状态，则stop后这种不一致状态对其他线程可见。我们视为这种不一致状态的对象被“损坏”，当线程操作“损坏”对象时，可能发生任意（无法预测）行为，它们可能非常微妙且难以检测">
<meta name="keywords" content="thread">
<meta property="og:type" content="article">
<meta property="og:title" content="译|Java Thread Primitive Deprecation">
<meta property="og:url" content="fengxiu.tech/posts/837ff6d6/index.html">
<meta property="og:site_name" content="枫秀">
<meta property="og:description" content="原文 为何废弃 Thread.stop因为它本质上是不安全的。stop线程将导致释放其持有的全部monitor（ThreadDeath异常在栈中传播时，monitor被解锁），若在当前线程中，这些monitor保护的对象处于不一致状态，则stop后这种不一致状态对其他线程可见。我们视为这种不一致状态的对象被“损坏”，当线程操作“损坏”对象时，可能发生任意（无法预测）行为，它们可能非常微妙且难以检测">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2021-09-07T09:17:54.312Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="译|Java Thread Primitive Deprecation">
<meta name="twitter:description" content="原文 为何废弃 Thread.stop因为它本质上是不安全的。stop线程将导致释放其持有的全部monitor（ThreadDeath异常在栈中传播时，monitor被解锁），若在当前线程中，这些monitor保护的对象处于不一致状态，则stop后这种不一致状态对其他线程可见。我们视为这种不一致状态的对象被“损坏”，当线程操作“损坏”对象时，可能发生任意（无法预测）行为，它们可能非常微妙且难以检测">






  <link rel="canonical" href="fengxiu.tech/posts/837ff6d6/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>译|Java Thread Primitive Deprecation | 枫秀</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">枫秀</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-时间轴">

    
    
    
      
    

    

    <a href="/timeAxis/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>时间轴</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/fengxiu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="fengxiu.tech/posts/837ff6d6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fengxiu">
      <meta itemprop="description" content="java,spring,分布式,数据库">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="枫秀">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">译|Java Thread Primitive Deprecation

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-28 15:36:15" itemprop="dateCreated datePublished" datetime="2019-07-28T15:36:15+08:00">2019-07-28</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/juc/" itemprop="url" rel="index"><span itemprop="name">juc</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/juc/thread/" itemprop="url" rel="index"><span itemprop="name">thread</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/837ff6d6/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/837ff6d6/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/837ff6d6/" class="leancloud_visitors" data-flag-title="译|Java Thread Primitive Deprecation">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">6.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">6 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/concurrency/threadPrimitiveDeprecation.html" target="_blank" rel="noopener">原文</a></p>
<h2 id="为何废弃-Thread-stop"><a href="#为何废弃-Thread-stop" class="headerlink" title="为何废弃 Thread.stop"></a>为何废弃 Thread.stop</h2><p>因为它本质上是不安全的。stop线程将导致释放其持有的全部monitor（ThreadDeath异常在栈中传播时，monitor被解锁），若在当前线程中，这些monitor保护的对象处于不一致状态，则stop后这种不一致状态对其他线程可见。我们视为这种不一致状态的对象被“损坏”，当线程操作“损坏”对象时，可能发生任意（无法预测）行为，它们可能非常微妙且难以检测，也可能抛出这些异常。与其他非检查异常不同，ThreadDeath悄悄杀死线程，用户无法收到任何警告，用户可能到几个小时，或几天会才能发现问题。<br><a id="more"></a></p>
<h2 id="是否可以捕获ThreadDeath并修复“损坏”对象"><a href="#是否可以捕获ThreadDeath并修复“损坏”对象" class="headerlink" title="是否可以捕获ThreadDeath并修复“损坏”对象"></a>是否可以捕获ThreadDeath并修复“损坏”对象</h2><p>理论上可行，但这将极大地使编写正确的多线程代码的任务复杂化。由于两个原因几乎不可能做到：</p>
<ol>
<li>线程几乎可以在任何地方抛出ThreadDeath，因此所有同步方法、同步代码块都需要仔细设计；并且时刻记住这点。</li>
<li>处理已捕获的ThreadDeath时，可能再次抛出ThreadDeath，因此必须不断重复清理，直至成功，代码会非常复杂；</li>
</ol>
<p>因此，这样做不切实际。</p>
<h2 id="Thread-stop-Throwable-呢"><a href="#Thread-stop-Throwable-呢" class="headerlink" title="Thread.stop(Throwable) 呢"></a>Thread.stop(Throwable) 呢</h2><p>除了上面提到的所有问题之外，此方法还可以用于生成其目标线程没有准备好处理的异常（包括线程不可能抛出的已检查异常，如果不是此方法的话）。例如，下面的方法在行为上与Java的抛出操作完全相同，但绕过编译器的尝试，以确保调用方法声明了它可能抛出的所有检查异常,简单的理解这句话，就是可以抛出异常而不用捕获：</p>
<pre><code class="java">static void sneakyThrow(Throwable t) {
    Thread.currentThread().stop(t);
}
</code></pre>
<h2 id="用什么替代-Thread-stop"><a href="#用什么替代-Thread-stop" class="headerlink" title="用什么替代 Thread.stop"></a>用什么替代 Thread.stop</h2><p>stop的大多数用法都可以替换为只修改某个变量以指示目标线程应该停止运行的代码。目标线程应定期检查该变量，如果该变量指示它将停止运行，则应按顺序从其run方法返回。为了确保停止请求的及时通信，变量必须是volatile类型的（或者必须同步对变量的访问）</p>
<p>例如，假设小程序包含以下启动、停止和运行方法：</p>
<pre><code class="java">private Thread blinker;

public void start() {
    blinker = new Thread(this);
    blinker.start();
}

public void stop() {
    blinker.stop();  // UNSAFE!
}

public void run() {
    while (true) {
        try {
            Thread.sleep(interval);
        } catch (InterruptedException e){
        }
        repaint();
    }
}
</code></pre>
<p>可修改为：</p>
<pre><code class="java">private volatile Thread blinker;

public void stop() {
    blinker = null;
}

public void run() {
    Thread thisThread = Thread.currentThread();
    while (blinker == thisThread) {  // 运行标识
        try {
            Thread.sleep(interval);
        } catch (InterruptedException e){
        }
        repaint();
    }
}
</code></pre>
<p>目标线程检测到停止请求后，可以做必要的资源清理，相比直接释放锁，进而处于不一致状态要好很多。</p>
<h2 id="如何停止长时间等待的线程（如等待输入）"><a href="#如何停止长时间等待的线程（如等待输入）" class="headerlink" title="如何停止长时间等待的线程（如等待输入）"></a>如何停止长时间等待的线程（如等待输入）</h2><p>这就是thread.interrupt方法的用途。可以使用上面所示的相同“基于状态”的信令机制，但状态更改（在前一个示例中，blinker=null）之后可以调用thread.interrupt来中断等待：</p>
<pre><code class="java">public void stop() {
    Thread moribund = waiter;
    waiter = null;
    moribund.interrupt();
}
</code></pre>
<p>对于使用这种技术来运行的代码，任何捕获到中断异常但不准备立即处理它的方法都必须重新声明异常。我们说重新声明而不是重新引发，因为不可能总是重新引发异常。如果捕获InterruptedException的方法未声明为引发此（选中）异常，应该再一次进行自我中断，是可以使用下面这行代码</p>
<pre><code class="java">Thread.currentThread().interrupt();
</code></pre>
<p>这样可以确保线程能够尽快重新发出InterruptedException。</p>
<h2 id="线程未响应Thread-interrupt怎么办"><a href="#线程未响应Thread-interrupt怎么办" class="headerlink" title="线程未响应Thread.interrupt怎么办"></a>线程未响应Thread.interrupt怎么办</h2><p>在某些情况下，您可以使用特定于应用程序的技巧。例如，如果一个线程正在等待一个已知的套接字，您可以关闭该套接字以使该线程立即返回。不幸的是，实际上没有任何一种技术在一般情况下起作用。应该注意，在所有等待线程不响应thread.interrupt的情况下，它也不会响应thread.stop。这种情况包括故意拒绝服务攻击，以及thread.stop和thread.interrupt不能正常工作的I/O操作。</p>
<h2 id="Thread-suspend和Thread-resume也被废弃了"><a href="#Thread-suspend和Thread-resume也被废弃了" class="headerlink" title="Thread.suspend和Thread.resume也被废弃了"></a>Thread.suspend和Thread.resume也被废弃了</h2><p>thread.suspend天生就容易死锁。如果目标线程在挂起时在保护关键系统资源的监视器上持有锁，则在恢复目标线程之前，任何线程都无法访问此资源。如果要恢复目标线程的线程在调用resume之前尝试锁定此监视器，则会导致死锁。这种死锁通常表现为“冻结”的进程。</p>
<p>若线程一 suspend 时通过 monitor A 保护稀有资源，则 suspend 后线程一 不释放 minotor A，因此其他线程无法访问该资源，直至线程一 resume。若恢复线程一的线程在调用 resume 前需要获取 monitor A，则发生死锁。</p>
<p>resume 为服务 suspend 而存在。</p>
<p>对此 Thread.suspend 方法的注释也有解释：</p>
<pre><code class="txt">This method has been deprecated, as it is inherently deadlock-prone.

If the target thread holds a lock on the monitor protecting a 
critical system resource when it is suspended, no thread can 
access this resource until the target thread is resumed. 

If the thread that would resume the target thread attempts 
to lock this monitor prior to calling resume, deadlock results.  

Such deadlocks typically manifest themselves as &quot;frozen&quot; processes.
</code></pre>
<p>suspend 容易死锁的根因是它 不释放锁，resume 它的线程如果要请求同样的锁，则挂起线程永远无法恢复。</p>
<h2 id="用什么替代-Thread-suspend-和-Thread-resume"><a href="#用什么替代-Thread-suspend-和-Thread-resume" class="headerlink" title="用什么替代 Thread.suspend 和 Thread.resume"></a>用什么替代 Thread.suspend 和 Thread.resume</h2><p>与thread.stop一样，谨慎的方法是让“目标线程”轮询一个变量，该变量指示线程的所需状态（活动或挂起）。当所需状态被挂起时，线程将使用object.wait等待。当线程恢复时，将使用object.notify通知目标线程。</p>
<p>例如，假设小程序包含以下MousePresed事件处理程序，它切换名为blinker的线程的状态：</p>
<pre><code class="java">
private boolean threadSuspended;

Public void mousePressed(MouseEvent e) {
    e.consume();

    if (threadSuspended)
        blinker.resume();
    else
        blinker.suspend();  // DEADLOCK-PRONE!

    threadSuspended = !threadSuspended;
}
</code></pre>
<p>通过将上面的事件处理程序替换为以下内容，可以避免使用thread.suspend和thread.resume：</p>
<pre><code class="java">public synchronized void mousePressed(MouseEvent e) {
    e.consume();

    threadSuspended = !threadSuspended;

    if (!threadSuspended)
        notify();
}
</code></pre>
<p>然后在run循环中添加：</p>
<pre><code class="java">synchronized(this) {
    while (threadSuspended)
       wait();
}
</code></pre>
<p>wait方法抛出InterruptedException，因此它必须在try—catch子句。把它和sleep放在相同的区块里没关系。检查应该在sleep之后（而不是在sleep之前）进行，这样当线程“恢复”时，窗口会立即重新绘制。生成的运行方法如下：</p>
<pre><code class="java">public void run() {
    while (true) {
        try {
            Thread.sleep(interval);

            synchronized(this) {
                while (threadSuspended)
                    wait();
            }
        } catch (InterruptedException e){
        }
        repaint();
    }
}
</code></pre>
<p>请注意，mousePresed方法中的notify和run方法中的wait位于synchronized块内。这是语言所必需的，并确保wait和notify正确序列化。实际上，这消除了可能导致“挂起”线程错过通知并无限期保持挂起的争用条件。虽然Java中的同步成本随着平台的成熟而减少，但它永远不会是免费的。可以使用一个简单的技巧来删除我们在“运行循环”的每个迭代中添加的同步。添加的同步块被一段稍微复杂一些的代码替换，该代码只在线程实际挂起时才进入同步块：</p>
<pre><code class="java">if (threadSuspended) {
    synchronized(this) {
        while (threadSuspended)
            wait();
    }
}
</code></pre>
<p>在没有显式同步的情况下，threadsuspend必须是易失性的，以确保挂起请求的及时通信。</p>
<p>最后 run 为：</p>
<pre><code class="java">private volatile boolean threadSuspended;

public void run() {
    while (true) {
        try {
            Thread.sleep(interval);

            if (threadSuspended) {
                synchronized(this) {
                    while (threadSuspended)
                        wait();
                }
            }
        } catch (InterruptedException e) {
        }
        repaint();
    }
}
</code></pre>
<h2 id="可以结合这两种技术来生成一个可以安全地“stoped”或“suspended”的线程吗"><a href="#可以结合这两种技术来生成一个可以安全地“stoped”或“suspended”的线程吗" class="headerlink" title="可以结合这两种技术来生成一个可以安全地“stoped”或“suspended”的线程吗"></a>可以结合这两种技术来生成一个可以安全地“stoped”或“suspended”的线程吗</h2><p>是的，这很简单。其中一个微妙之处是，目标线程可能已经在另一个线程试图停止它时挂起。如果stop方法只将状态变量（blinker）设置为空，则目标线程将保持挂起状态（等待监视器），而不是像应该的那样优雅地退出。如果重新启动小程序，多个线程可能最终同时在监视器上等待，从而导致不稳定的行为。要纠正这种情况，stop方法必须确保目标线程在挂起时立即恢复。一旦目标线程恢复，它必须立即识别它已经停止，并优雅地退出。以下是生成的运行和停止方法的外观：</p>
<pre><code class="java">
public void run() {
    Thread thisThread = Thread.currentThread();
    while (blinker == thisThread) {
        try {
            Thread.sleep(interval);

            synchronized(this) {
                while (threadSuspended &amp;&amp; blinker == thisThread)
                    wait();
            }
        } catch (InterruptedException e) {
        }
        repaint();
    }
}

public synchronized void stop() {
    blinker = null;
    notify();
}
</code></pre>
<p>若 stop 调用 Thread.interrupt，就不用调用 notify，但 stop 还是必须用 synchronized 修饰，同步可以保证目标线程不会因为竞态条件而错误中断。</p>
<h2 id="Thread-destroy呢"><a href="#Thread-destroy呢" class="headerlink" title="Thread.destroy呢"></a>Thread.destroy呢</h2><p>Thread.destroy 从来没被实现，并且已被废弃。即使实现了 destory，与 Thread.suspend 类似，destroy 容易导致死锁。</p>
<h2 id="为什么runtime-runFinalizersonexit被废弃"><a href="#为什么runtime-runFinalizersonexit被废弃" class="headerlink" title="为什么runtime.runFinalizersonexit被废弃"></a>为什么runtime.runFinalizersonexit被废弃</h2><p>因为它本质上是不安全的。它可能导致对活动对象调用终结器，而其他线程同时操作这些对象，从而导致不稳定的行为或死锁。如果对象被最终确定的类被编码为“防御”这个调用，那么这个问题就可以避免，但大多数程序员并不防御它。它们假定在调用对象的终结器时对象已死亡。<br>此外，在设置VM全局标志的意义上，调用不是“线程安全的”。这将强制每个类使用终结器来防御活动对象的终结！</p>

      
    </div>

    
      


    

    
    
    

      
        <div>
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/posts/837ff6d6/">译|Java Thread Primitive Deprecation</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 fengxiu 的个人博客">fengxiu</a></p>
  <p><span>发布时间:</span>2019年07月28日 - 15:36</p>
  <p><span>最后更新:</span>2021年09月07日 - 17:17</p>
  <p><span>原始链接:</span>
     <a href="/posts/837ff6d6/" title="译|Java Thread Primitive Deprecation">译|Java Thread Primitive Deprecation</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="fengxiu.tech/posts/837ff6d6/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
    });
    });  
</script>

        </div>
      

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/thread/" rel="tag">  <i class="fa fa-tag"></i> thread</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/8300084f/" rel="next" title="NIO vs BIO该如何选择">
                <i class="fa fa-chevron-left"></i> NIO vs BIO该如何选择
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/8551d0c1/" rel="prev" title="数据库连接池大小设置">
                数据库连接池大小设置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="fengxiu">
            
              <p class="site-author-name" itemprop="name">fengxiu</p>
              <p class="site-description motion-element" itemprop="description">java,spring,分布式,数据库</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">194</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">94</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/fengxiutianya" title="GitHub &rarr; https://github.com/fengxiutianya" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="mailto:398757724@qq.com" title="E-Mail &rarr; mailto:398757724@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为何废弃-Thread-stop"><span class="nav-number">1.</span> <span class="nav-text">为何废弃 Thread.stop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#是否可以捕获ThreadDeath并修复“损坏”对象"><span class="nav-number">2.</span> <span class="nav-text">是否可以捕获ThreadDeath并修复“损坏”对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thread-stop-Throwable-呢"><span class="nav-number">3.</span> <span class="nav-text">Thread.stop(Throwable) 呢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用什么替代-Thread-stop"><span class="nav-number">4.</span> <span class="nav-text">用什么替代 Thread.stop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何停止长时间等待的线程（如等待输入）"><span class="nav-number">5.</span> <span class="nav-text">如何停止长时间等待的线程（如等待输入）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程未响应Thread-interrupt怎么办"><span class="nav-number">6.</span> <span class="nav-text">线程未响应Thread.interrupt怎么办</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thread-suspend和Thread-resume也被废弃了"><span class="nav-number">7.</span> <span class="nav-text">Thread.suspend和Thread.resume也被废弃了</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用什么替代-Thread-suspend-和-Thread-resume"><span class="nav-number">8.</span> <span class="nav-text">用什么替代 Thread.suspend 和 Thread.resume</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可以结合这两种技术来生成一个可以安全地“stoped”或“suspended”的线程吗"><span class="nav-number">9.</span> <span class="nav-text">可以结合这两种技术来生成一个可以安全地“stoped”或“suspended”的线程吗</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thread-destroy呢"><span class="nav-number">10.</span> <span class="nav-text">Thread.destroy呢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么runtime-runFinalizersonexit被废弃"><span class="nav-number">11.</span> <span class="nav-text">为什么runtime.runFinalizersonexit被废弃</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fengxiu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      
      网站总字数
    </span>
    
    <span title="站点总字数">1.5m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      
      总阅读时长
    </span>
    
    <span title="站点阅读时长">23:09</span>
  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  








  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>











  



  
  <script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script>

  
  <script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  

  
    <script id="dsq-count-scr" src="https://fengxiu.disqus.com/count.js" async></script>
  

  
    <script>
      var disqus_config = function () {
        this.page.url = "fengxiu.tech/posts/837ff6d6/";
        this.page.identifier = "posts/837ff6d6/";
        this.page.title = '译|Java Thread Primitive Deprecation';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://fengxiu.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        $(function () {
          var offsetTop = $('#comments').offset().top - $(window).height();
          if (offsetTop <= 0) {
            // load directly when there's no a scrollbar
            loadComments();
          } else {
            $(window).on('scroll.disqus_scroll', function () {
              // offsetTop may changes because of manually resizing browser window or lazy loading images.
              var offsetTop = $('#comments').offset().top - $(window).height();
              var scrollTop = $(window).scrollTop();

              // pre-load comments a bit? (margin or anything else)
              if (offsetTop - scrollTop < 60) {
                $(window).off('.disqus_scroll');
                loadComments();
              }
            });
          }
        });
      
    </script>
  













  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=6.7.0"></script>



  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "8rM8gj5HTRTSqBQdFyePed86-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "8rM8gj5HTRTSqBQdFyePed86-gzGzoHsz",
                'X-LC-Key': "f92qb0ijeNp2joqk3ld6IlRW",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  
  

  
  

  


  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


  

  
  
  

  <link rel="stylesheet" href="/lib/prettify/themes/atelier-estuary-light.min.css" type="text/css">


<script src="/lib/prettify/prettify.js"></script>
<script type="text/javascript">

$(window).load(function(){

  // 设置prettify
  $('pre').addClass('prettyprint linenums');
   prettyPrint();
 })
</script>
<style>
pre {
  white-space:pre;
  white-space:pre-wrap;
  word-break:break-all;
  word-wrap:break-word;
}
</style>




  
  
</body>
</html>
